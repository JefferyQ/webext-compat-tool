<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://code.cdn.mozilla.net/fonts/fira.css">
    <link rel="stylesheet" href="/style.css">
    <title>Extension Compatibility Tester</title>
  </head>
  <body>
    <header class="header">
      <h1 class="masthead">
        Extension Compatibility Tester
      </h1>
    </header>

    <div class="row highlight">
      <section class="processing-status section">
        <h1 class="status"></h1>
      </section>
    </div>

    <div class="row results highlight">
      <section class="section">
        <header class="report-summary">
        </header>
        <details>
          <summary>
            <h3>Report Details</h3>
          </summary>
          <pre class="report-details"></pre>
        </details>
      </section>
    </div>

    <div class="row results next-steps">
      <section class="section">
        <h1>What's Next?</h1>
        <ol>
          <li>
            <h2>Test Your Extension in Firefox</h2>
            <p>
              We created this tool to help you find and fix compatibility
              issues, but nothing beats some good old-fashioned testing in the
              browser. Take time to check the appearance or functionality of
              your extension to ensure it meets your expectations.
            </p>
          </li>
          <li>
            <h2>Package Your Extension</h2>
          </li>
        </ol>
      </section>
    </div>

    <div class="row footer highlight">
      <footer class="section">
        This tool provided with &hearts; by Mozilla.
      </footer>
    </div>

    <script src="/dom.js"></script>
    <script>

      var id = location.toString().match(/test\/([a-fA-F0-9-]+)/)[1];

      function checkStatus() {
        fetch('/status/' + id)
          .then(r => r.json())
          .then(status => {
            if (status.state === 'waiting') {
              document.querySelector('.status').innerHTML = 'Waiting in line for a linter to become available&hellip;';
            } else {
              document.querySelector('.status').innerHTML = status.state;
            }

            if (status.state === 'complete') {
              document.querySelector('body').classList.add('complete');

              let results = Object.entries(status.results).reduce((result, [type, entries]) => {
                result[type] = Object.values(entries.reduce((result, entry) => {
                  if (!result[entry.message]) {
                    result[entry.message] = {
                      message: entry.message,
                      locations: []
                    };
                  }
                  result[entry.message].locations.push({
                    file: entry.file,
                    line: entry.line
                  });
                  return result;
                }, {}));
                return result;
              }, {});

              showReport(results);
            } else if (status.state === 'error') {
              document.querySelector('body').classList.add('complete');
              showError(status.error);
            } else {
              setTimeout(checkStatus, 1000);
            }
          });
      }

      function showError(error) {
        let summary = document.querySelector('.report-summary');
        let output = d(
          d('h1', 'Error processing your package:'),
          d('h2', error)
        );

        summary.appendChild(output.toDom());
      }

      function showReport(results) {
        let summary = document.querySelector('.report-summary');
        let details = document.querySelector('.report-details');

        let report;
        if (results.compat.length) {
          report = d(
            d('h1', 'This extension may not be compatible with Firefox!'),
            d('h2',
              results.compat.length,
              (results.compat.length > 1 ?
                ' compatibility issues ' :
                ' compatibility issue '
              ),
              'found:'
            ),
            d('ul',
              results.compat.map(m => d('li',
                d('h3', m.message),
                d('p', 'found in the following locations:'),
                d('ul', {'class': 'locations'},
                  m.locations.map(l => d('li',
                    l.file,
                    (l.line ? ':' + l.line : '')
                  ))
                )
              ))
            )
          );
        } else {
          report = d('h1', 'This extension is compatible with Firefox!');
        }

        summary.appendChild(report.toDom());

        details.innerHTML = JSON.stringify(results, null, 2);
      }

      checkStatus();
    </script>
  </body>
</html>
